

- name: Install mysql repo on CentOS-8
  ansible.builtin.shell: curl -s -L -o /etc/yum.repos.d/mysql.repo https://raw.githubusercontent.com/roboshop-devops-project/mysql/main/mysql.repo
  ignore_errors: true  


- name: disable mysql module
  ansible.builtin.shell: dnf module disable mysql
  ignore_errors: true


- name: Install the  redis package
  ansible.builtin.yum:
    name: mysql-community-server
    state: present


- name: Enable and start the service
  ansible.builtin.systemd:
    name: mysqld
    state: started
    enabled: true    
    daemon_reload: yes 

- name: DEFAULT_PASSWORD 
  ansible.builtin.shell: grep 'A temporary password' /var/log/mysqld.log | cut -d " " -f 11
  register: out 

- name: get the uptime data from defined variable
  ansible.builtin.debug:
   msg: "{{out.stdout}}"  


- name: validate wheather we were able to connect uisng the default password 
  ansible.builtin.shell: echo "show databases;" | mysql --connect-expired-password -uroot -p{{out.stdout}}
  ignore_errors: true
  register: mysql_conn_status




# echo "show databases;" | mysql --connect-expired-password -uroot -p${DEFAULT_PASSWORD}
# if [ $? -ne 0 ]; then 
# echo " change the default password"
# mysql --connect-expired-password -uroot -p${DEFAULT_PASSWORD} < /tmp/set-root-passwd.sql 
# #&>>$LOG_FILE
# #Statuscheck $?
# echo " uninstall plugin validate_password; " | mysql -uroot -p$1 &>>$LOG_FILE
# Statuscheck $?
# fi 

# echo " cleanup before installation"
# rm -rf /tmp/mysql.zip &>>$LOG_FILE
# Statuscheck $?
# rm -rf /tmp/mysql-main &>>$LOG_FILE
# Statuscheck $?

# echo "download the database"
# curl -s -L -o /tmp/mysql.zip "https://github.com/roboshop-devops-project/mysql/archive/main.zip" &>>$LOG_FILE
# Statuscheck $?

# echo "Load the schema for Services"
# cd /tmp
# unzip mysql.zip
# cd mysql-main
# mysql -uroot -p$1 <shipping.sql  &>>$LOG_FILE
# Statuscheck $?

